Soft-typing for PHP5
=====================
:language: bash

NOTE: Look for the README.html file in the same folder, it contains a more
      readable variant of this text file.

Author
-------
Henk Erik van der Hoek (Initial Project (https://github.com/henkerik/typing))
Marcelo Sousa <dipython@gmail.com> (MSc. Computing Science student Utrecht Universiteit)

NOTE: Building the HTML version of this document requires `asciidoc` with either
      pygments or gnu source highlight. asciidoc can be easily installed from 
      source.

Introduction
------------
This Experimentation Project is related to my MSc. Computing Science 
at the University of Utrecht from October 2011 and it's based on previous work of
Henk Erik van der Hoek (https://github.com/henkerik/typing). 
The goal of the project continues to be static type inference of variables in 
PHP programs to provide suitable warnings whenever a program is likely to be incorrect. 

Installing
----------
All of these can be installed using cabal. The code itself can
be compiled with the command:

[source]
----
cabal configure && cabal build.
----

or simply:

[source]
----
make
----

Running
-------
To analyze the file input.php use:

[source]
----
./run
----

To run the testsuite type:

[source]
----
typing_tester
----

The analysis
------------
The goal of the analysis is to find for each program-point in the program which
variables are in scope and what their possible types are at that point.
Following the initial approach by Henk Erik this was realized by specifying the 
problem as a monotone framework instance for a forward analysis and by solving the instance using a iterative work-list algorithm. 
The theory behind monotone frameworks is described in Principles of Program Analysis by Nielson, Nielson & Hankin (NNH). 
During the execution of each transfer function constraints for the PHP expression at hand are generated, 
and the type of an expression is found by resolving these constraints. This idea was described 
by Camphuijsen in his thesis "Soft typing and analyses on PHP programs".


General Architecture 
--------------------
(heavily based on Henk Erik's work)

At the moment the code base is clearly separated between the monotone framework and a generic work-list algorithm
on one side and the framework instances on the other side. Beside soft typing, several other analyses were
implemented as well (*). This was done to get the boundary between framework and instances clear. 
These additional analyses all operate on the While language, a small imperative language defined by NNH. 

The soft typing analyses contains two distinct phases. In the first phase an instance of the monotone
framework is specified and solved. The result is a mapping between variable and type for any given 
program point. In the second phase this result is used to check wether these types match the types 
we expect. The second process doesn't specify or solve a monotone framework instance and could be 
considered a post processing step. 

The following files and directories might be of special interest:
----

| File or directory                      | Description                                                           |
|:---------------------------------------|:----------------------------------------------------------------------|
| src/grammar                            | sglri php5 definitions (do not change)                                |
| src/MF/Core.hs                         | Implements the work-list algorithm (look for the 'solve' function)    |
| src/MF/Languages/PHP/AG/Flow.ag        | Implements the conversion of an AST to a flow graph                   |
| src/MF/Languages/PHP/AG/Typing.ag      | Implements the constraint generation, the transfer function and       |
|                                        | specifies an instance of the monotone framework                       |
| src/MF/Languages/PHP/AG/Checking.ag    | Implements the expected constraint generation and generates warnings  |
|                                        | when the expected constraints don't match the types found by running  |
|                                        | the work-list algorithm.	                                             |


(*) : Currently these analyses additional analyses don't compile due to recent changes in the Flowable class


Supported PHP5 features
-----------------------

1. Supports HTML Embedding (tests/syntax/htmlembedding.php)
2. While-construct (tests/controlstruct/while.php)
3. Function calls
4. Booleans (tests/basicdatatypes/scalar/boolean/boolean.php)
5. Double quoted strings (basicdatatypes/scalar/string/doublequoted.php)
6. Creating/modifying with square bracket syntax
7. Ifelse constructs (tests/controlstruct/ifelse.php)

Non-Supported PHP5 features
---------------------------

0. Print, Echo functions (semantics, flow)
13. PreInc and PostInc not implemented (tests/postinc.php, tests/preposincrement.php)
24. PlusAssign (tests/plusassign.php)
33. XorAssign not implemented (tests/efficientswap.php)
37. Greater, GreaterEqual, Less (tests/controlstruct/elseif.php)

Syntax
------
3. TemplateDocument (tests/syntax/phptagecho.php, tests/syntax/phptagscript.php)
4. Comments in the sense that they are removed by sglri
16. InlineHTML not implemented (tests/syntax/advancedescaping.php)
17. Error in ATerm: DQContent takes 1 arguments, but 3 were given. (tests/syntax/phptagsimple.php)
18. ASPOpenTag not implemented (still runs because it's ignored) (tests/syntax/phptagasp.php)
19. "In PHP 5.2 and earlier, the parser does not allow the <?php opening tag to be the only thing in a file. This is allowed as of PHP 5.3." (tests/syntax/phptagstandard.php, tests/syntax/instructionseparation.php)
20. sglri does not allow combination of different sytles of open-close tags (tests/syntax/phptagcombination.php)


Types
-----
9. SingleQuoted strings not implemented (tests/basicsdatatypes/scalar/string/singlequoted.php)
1. Heredoc (tests/basicsdatatypes/scalar/string/heredoc.php)
2. Nowdoc (tests/basicsdatatypes/scalar/string/nowdoc.php)
25. StringAccess not implemented (tests/basicsdatatypes/scalar/string/stringindex.php)
21. Negative integers not implemented (tests/basicdatatypes/scalar/integer/integerliteral.php)
22. Octal integers not implemented (tests/basicdatatypes/scalar/integer/integerliteral.php)
23. Hexa integers not implemented (tests/basicdatatypes/scalar/integer/integerliteral.php)
5. Floating-point types (tests/basicdatatypes/scalar/float/*)
26. Standard array creation not implemented (tests/basicdatatypes/compound/array/arraycreation*.php)
43. ListAssign (tests/controlstruct/whilebreak.php)
27. No support for classes/objects (tests/basicdatatypes/compound/object/*)
28. Resources are not implemented (no test file)
29. NULL type not implemented (tests/basicdatatypes/null.php)
31. Callback (tests/basicdatatypes/callback/callback.php)
32. tests/basicdatatypes/typejuggling.php analysis is wrong

Variables
---------
6. Use of $GLOBALS and variable scope (tests/variables/varscope/globals*)
7. IndirectReference not implemented (tests/variables/indirectrefvar.php)
31. ReferenceAssign not implemented (tests/variables/varreference.php)
8. InternalFunction not implemented (tests/variables/varmanage/isset.php, tests/varmanage/empty.php, tests/include.php)
10. Unset not implemented (tests/variables/varmanage/unset.php)
11. Superglobals (not sure because can't test since SingleQuoted is not working)
12. DeclareGlobal not implemented (tests/variables/varscope/global.php)
34. define function for constants not implemented (tests/variables/constantvar2.php)
16. Constant variables (tests/constantvar.php)
14. DeclareStatic not implemented (tests/varscope/static.php)

Control Structures
------------------
28. Foreach not implemented (tests/foreach.php)
1. If-constructs don't work if they don't have else clauses (tests/controlstruct/if.php)
35. Ternary conditional operator not implemented (tests/ternaryconditionalop.php)
36. Short-circuiting 
38. Else-if (tests/controlstruct/elseif.php)
39. AltIf (tests/controlstruct/ifelsealt.php)
40. AltWhile (tests/controlstruct/while3.php)
41. DoWhile (tests/controlstruct/dowhile.php, tests/controlstruct/dowhilebreak.php)
42. For (tests/controlstruct/for.php)
44. Break (tests/controlstruct/whilebreak.php)
45. Continue (tests/controlstruct/whilecontinue.php)
46. Switch (tests/controlstruct/switch.php)
47. Declare (tests/controlstruct/declare.php)
48. sglri does not support Goto (tests/controlstruct/goto.php)
49. empty block (tests/functions/funconditional.php)

Functions
---------
30. sglri seems to now allow lambdas! (tests/basicsdatatypes/callback/callbackclosure.php)
15. Recursive functions with static variables (tests/functions/countTo10.php)
50. conditional functions (tests/functions/funconditional.php)

Useful functions
----------------
vamanage functions (tests/varmanage/*)
var_dump (tests/basicdatatypes/scalar/boolean/boolcheck.php)
gettype  (tests/basicdatatypes/gettype.php)
error_reporting(E_ALL);
ini_set('display_errors', true);
ini_set('html_errors', false);
settype()

The used lattice
----------------

MFP - Minimal Fixed Point
--------------------------
Elaborate

Embellished monotone framework
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Usage and Graph Generation
--------------------------

Notes on the language
---------------------

* PHP and short-circuiting
